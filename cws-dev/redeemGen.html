<!DOCTYPE html>
<html lang="en" class="bg-color">

  <head>
    <title>CwS - Provider: redeemGen</title>
    <script type="text/javascript" src="scripts/libraries/jquery-3.4.0.js" ></script>
    <script type="text/javascript" src="scripts/constants/constants.js"></script>
    <script type="text/javascript" src="scripts/utils/util.js" ></script>
    <style>
        div.label {
            width:150px;
        }
        div.output { font-family: monospace; }
        input.button { width:120px;}
    </style>
  </head>
 
  <body>

    <table style="width:100%;height:100%">
        <tr>
            <td>
                
                <!-- INPUT  -->

                <table>

                    <tr>
                        <td>
                            <div class="label">user</div>
                        </td>
                        <td>
                            <input type="text" class="user" value="1004">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="label">status</div>
                        </td>
                        <td>
                            <select class="status">
                                <option value="random">mixed</option>
                                <option value="queued">queued</option>
                                <option value="submit">submit</option>
                                <option value="failed">failed</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="label">redeem url</div>
                        </td>
                        <td>
                            <input type="text" class="redeemURL" value="" >
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right">
                            <div class="label">Activity types</div>
                        </td>
                        <td>
                            <input type="text" class="activityType" value="">
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right">
                            <div class="label">rows</div>
                        </td>
                        <td>
                            <input type="text" class="rows" value="20">
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right">
                            <div class="label">open From</div>
                        </td>
                        <td>
                            <select class="openHourFrom"></select>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right">
                            <div class="label">open To</div>
                        </td>
                        <td>
                            <select class="openHourTo"></select>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right">
                            <div class="label">DELETE Indexed DB</div>
                        </td>
                        <td>
                            <input type="checkbox" id="deleteIndexedDB">
                        </td>
                    </tr>
                </table>

            </td>
        </tr>

        <tr>
            <td>
                <table>
                    <tr>
                        <td>
                            <div class="label"></div>
                        </td>
                        <td>
                            <input type="button" class="button" value="generate" onclick="generate()">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>

        <tr>
            <td>
                
                <!-- OUTPUT  -->

                <!-- <div class="output" style="width:600px;height:100%;min-height:200px;border:1px solid #C0C0C0;overflow: scroll"></div>  -->
                <textarea class="output" style="min-width:50%;height:100%;min-height:200px;border:1px solid #C0C0C0;overflow: scroll"></textarea> 

            </td>
        </tr>

        <tr>
            <td>
                <table>
                    <tr>
                        <td>
                            <div style="text-align:right">localStorage</div>
                        </td>
                        <td>
                                <input type="button" class="button" value="Overwrite" onclick="writeToLocalStorage(true)">
                                <input type="button" class="button" value="Append" DISABLED onclick="writeToLocalStorage(false)">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <div id="f1_container">
        <div id="f1_card" class="shadow">
            <div class="front face">
                <img src="images/Connect.svg"/>
            </div>
            <div class="back face center">
                    <img src="images/Connect.svg"/>
            </div>
        </div>
    </div>

    <script>

        $('input.redeemURL').css ( 'width',  $('textarea.output').css('width').replace('px','') - 90 );
        $('input.redeemURL').val ( location.origin + '/eRefWSDev3/api/dc/redeem')
        $('input.activityType').val( (getRedeemDefs()) );
        $( 'select.openHourFrom' ).html( getOpenHours(6) );
        $( 'select.openHourTo' ).html( getOpenHours(14) );
        //$( '#deleteIndexedDB' ).checked( false );

        if ( localStorage.getItem (Constants.storageName_session) )
        {
            $('input.user').val ( JSON.parse(localStorage.getItem (Constants.storageName_session)).user )
        }

        //http://localhost:8080/eRefWSDev3/api/dc/redeem
    
    function getOpenHours( def )
    {
        var opts = '';
        
        for (var i = 0; i < 24; i+= 0.25) 
        {
            opts += '<option value=' + i ; //Util.paddNumeric( i, 2 )
            if ( def == i) opts += ' SELECTED ';
            opts += '>' + formatTime( new Date( 86400000 * ( i / 24 ) ) ) + '</option>';
        }

        return opts;

    }

    
    function formatTime( datetimeStamp )
    {
        var date = new Date( datetimeStamp );
        var hours = date.getHours()
        var minutes = date.getMinutes()
        //var seconds = date.getSeconds();

        if (hours < 10) hours = '0' + hours;
        if (minutes < 10) minutes = '0' + minutes;
        //if (seconds < 10) seconds = '0' + seconds;

        return ( hours + ':' + minutes ); //+ ':' + seconds 
    }
    
    function generate()
    {
        var myTemplate = template();
        var myDateTimeSeed = Util.dateToString( new Date() ) + 'T00:00:00Z'; //new Date();
        var myResult = '', tmpRow = '';
        var prevFields = getPreviewDataFields();
        var likeFirstname, likeSurname, likeAge;

        for (var i = 1; i <= $('input.rows').val(); i++) 
        {
            myDateTimeSeed = getCalcTime(myDateTimeSeed, $('select.openHourFrom').val(), $('select.openHourTo').val() );
            //console.log( ' ~ ' + myDateTimeSeed );

            var myDate = getTodayDate(myDateTimeSeed);
            var myTime = getTimeNow(myDateTimeSeed);
            var myUniqueItm = (new Date() ).toISOString();

            tmpRow = myTemplate;

            let newID = generateRandomString(8);
            let rnd1 = generateRandomNumber(1);
            let rnd8 = generateRandomNumber(8);
            let rnd12 = generateRandomNumber(12);
            let mystatus = ( ($('select.status').val() == 'random') ? getRandomWord('submit,queued,failed',myUniqueItm) : $('select.status').val() );
            let myactType = getRandomWord( $('input.activityType').val () ,myUniqueItm);
            let myTown = getRandomWord( getTownList(), myUniqueItm);
            let myFirst = getRandomWord( getNameList(), myUniqueItm ).trim();
            let myLast = getRandomWord( getNameList(), myUniqueItm ).trim();

            tmpRow = tmpRow.replace( /{NEWID}/g, newID );
            tmpRow = tmpRow.replace( /{NUMERIC1}/g, rnd1 );
            tmpRow = tmpRow.replace( /{NUMERIC8}/g, generateRandomNumber(8) );
            tmpRow = tmpRow.replace( /{NUMERIC12}/g, rnd12 );
            tmpRow = tmpRow.replace( /{DATETODAY}/g, myDate );
            tmpRow = tmpRow.replace( /{TIMENOW}/g, myTime );
            tmpRow = tmpRow.replace( /{user}/g, $('input.user').val() );
            tmpRow = tmpRow.replace( /{status}/g, mystatus );
            tmpRow = tmpRow.replace( /{activitytype}/g, myactType );
            tmpRow = tmpRow.replace( /{addressCity}/g, myTown );
            tmpRow = tmpRow.replace( /{phoneContactConsent}/g, getRandomWord('YES,YESP,NO',myUniqueItm) );
            tmpRow = tmpRow.replace( /{phoneContactConsent_feedback}/g, getRandomWord('YES,YESP,NO',myUniqueItm) );
            tmpRow = tmpRow.replace( /{FIRSTNAME}/g, myFirst.split(' ')[0] );
            tmpRow = tmpRow.replace( /{LASTNAME}/g, myLast.split(' ')[1] );
            tmpRow = tmpRow.replace( /{AGE}/g, generateRandomNumberRange(18,49).toFixed(0) );
            tmpRow = tmpRow.replace( /{NETWORKATTEMPT}/g, generateRandomNumberRange(0,2).toFixed(0) );
            tmpRow = tmpRow.replace( /{redeemURL}/g, $('input.redeemURL').val() );

            tmpRow = ( getAdditionalFields( tmpRow ) );

            //console.log( ' ~ ' + tmpRow );

            myResult += tmpRow + ',';

            myDateTimeSeed = ( Util.dateToString( new Date( myDateTimeSeed ) ) + 'T00:00:00Z' );
            
        }

        myResult = myResult.substring(myResult,myResult.length-1);

        $('textarea.output').val( (myResult) );

    }

    function getRedeemDefs()
    {
        var ret = 'eVoucher,WalkInA,WalkInB,PhoneVoucher';

        if ( localStorage.getItem(Constants.storageName_session) )
        {
            var itms = JSON.parse(localStorage.getItem( JSON.parse(localStorage.getItem(Constants.storageName_session)).user )).dcdConfig.settings.redeemDefs.activityTypes;

            if ( itms.length )
            {
                ret = '';
                for (var i = 0; i < itms.length; i++) 
                {
                    ret += itms[ i ].name +',';
                }
                ret = ret.substring( 0, ret.length -1 );
            }

        }

        //console.log( ret );
        
        return ret;
    }

    function getAdditionalFields( currTemplate )
    {
        var ret = '';
        var arr;
        var retPush = JSON.parse( currTemplate );

        if ( localStorage.getItem(Constants.storageName_session) )
        {
            var itms = JSON.parse(localStorage.getItem( JSON.parse(localStorage.getItem(Constants.storageName_session)).user )).dcdConfig.settings.redeemDefs.activityTypes;

            if ( itms.length )
            {
                ret = '';
                for (var i = 0; i < itms.length; i++) 
                {
                    ret += itms[ i ].previewData.toString() +',';
                }
                ret = ret.substring( 0, ret.length -1 );
                ret = ret.replace(/ /g, ',')
                arr = ret.split( ',' );
            }

        }

        if ( arr )
        {
            for (var i = 0; i < arr.length; i++) 
            {
                if ( currTemplate.indexOf( arr[ i ] ) < 0 )
                {
                    retPush.data.previewJson[ arr[ i ] ] = arr[ i ];
                }
            }
        }

        return JSON.stringify( retPush );
    }

    function getPreviewDataFields()
    {

        if ( localStorage.getItem(Constants.storageName_session) )
        {
            var itms = JSON.parse(localStorage.getItem( JSON.parse(localStorage.getItem(Constants.storageName_session)).user )).dcdConfig.settings.redeemDefs.activityTypes;

            if ( itms.length )
            {
                ret = '';
                for (var i = 0; i < itms.length; i++) 
                {
                    ret += itms[ i ].previewData.toString() +',';
                }
                ret = ret.substring( 0, ret.length -1 );
                ret = ret.replace(/ /g, ',')
                arr = ret.split( ',' );

                return arr;
            }

        }
    }
    function getCalcTime(dtmSeed,openFrom,openTo)
    {
        var min = ( ( 86400000 * ( openFrom / 24 ) ) );
        var max = ( ( 86400000 * ( openTo / 24 ) ) );
        var rndOffset = generateRandomNumberRange( min, max );
        var rndDtm = ( new Date( dtmSeed ).getTime() - 86400000 + rndOffset );

        //console.log( ' ~  [' + dtmSeed + '] ' + new Date( rndDtm ).toISOString(), new Date( rndDtm ) );
        return new Date( rndDtm ).toISOString();
    }

    function getTownList()
    {
        return 'Angoche,Beira,Bilene,Catandica,Chibuto,Chicualacuala,Chimoio,Chinde,Chokwé,Cuamba,Dondo,Gurue,Inhambane,Lichinga,Manica,Maputo,Marracuene,Matola,Maxixe,Moatize,Mocambique,Mocimboa da Praia,Mocuba,Montepuez,Mueda,Naamcha,Nacala,Nampula,Palma,Pemba,Quelimane,Tete,Vilankulo,Xai-Xai,Zavala';
    }

    function getNameList()
    {
        return 'Vickey Vire, Yuri Youngquist, Sherice Sharma, Ariane Albert, Heather Hillock, Taunya Tubb, Lawanda Lord, Quentin Quesenberry, Terrance Tennyson, Rosaria Romberger, Joann Julius, Doyle Dunker, Carolina Casterline, Sherly Shupe, Dorris Degner, Xuan Xu, Mercedez Matheney, Jacque Jamerson, Lillian Lefler, Derek Deegan, Berenice Barboza, Charlene Marriot, Mariam Malott, Cyndy Carrozza, Shaquana Smith, Kendall Kitterman, Reagan Riehle, Mittie Maez, Carry Carstarphen, Nelida Nakano, Christoper Compo, Sadie Shedd, Coleen Samsonite, Estella Eutsler, Pamula Pannone, Keenan Kerber, Tyisha Tisdale, Ashlyn Aguirre, Ashlie Albritton, Willy Wonka, Diann Yowzer, Asha Carpenter, Devin Dashiell, Arvilla Alers, Sheba Sherron, Richard Racca, Elba Early, Coretta Cossey, Brande Bushnell, Larraine Samsung, Pilar Varillas, Gaspar Hernandez, Greg Rowles, James Chang, Bruno Raimbault, Rodolfo Melia, Chris Purdy, Martin Dale, Sam Sox, Joe Soap, Joan Sope';
    }

    function template()
    {
        return '{  "title":"Voucher: {NUMERIC8} - {DATETODAY} {TIMENOW}.00", "created":"{DATETODAY} {TIMENOW}.00", "owner":"{user}", "activityType": "{activitytype}", "id":"{NUMERIC12}", "status":"{status}", "queueStatus":"{status}","network":false, "networkAttempt":{NETWORKATTEMPT}, "history": [], "syncActionStarted": 0, ' +
             ' "data":{  "payloadJson":{  "countryType":"MZ", "walkIn_firstName":"{FIRSTNAME}", "walkIn_lastName":"{LASTNAME}", "walkIn_age":"{AGE}", "phoneNumber":"+99{NUMERIC8}", "phoneContactConsent":"{phoneContactConsent}", "phoneContactConsent_feedback":"{phoneContactConsent_feedback}", "cbdCase":"Y", "clientId":"", "voucherId":"", "cbdEnrollOuId":"", "walkInClientCase":"", "voucherCode":"{NUMERIC8}", "walkIn_birthDistrict":"MZ10", ' +
             ' "walkIn_birthOrder":"2", "walkIn_age":"28", "program":"FPL", "service":"COUNS", "typeOfMethodUser":"CONTINUE", "ownershipOfPhone":"NO", "addressCity":"{addressCity}", "addressNeighborhood":"addressNeighborhood", "pointOfReference":"A", "bookPageNumber":"2" ' +
             ' }, "previewJson": {}, ' +
             ' "url":"{redeemURL}", ' +
             ' "actionJson":{   "actionType":"sendToWS", "payloadBody":["voucherCode" ], "payloadHeader":[  "usr","pwd" ], "alertResult":"true", "wsNACase":{  "note":"display message" },' +
             ' "redeemListInsert":"true", "url":"/api/dc/redeem" }}} '
    }

    function templateA()
    {
        return '{  "title":"{DATETODAY} {TIMENOW}.00", "owner":"{user}", "activityType": "{activitytype}", "id":"{NUMERIC12}", "status":"{status}",  ' +
             ' "name": "{FIRSTNAME} {LASTNAME}", "phoneNumber": "+99{NUMERIC8}", "numField": "{NUMERIC1}", "seguimento": "Ninguno" } '
    }

    function getTodayDate(dtmSeed)
    {
        var date = new Date(dtmSeed);
        var month = eval( date.getMonth() ) + 1;
        month = ( month < 10 ) ? "0" + month : month;
        var day = eval( date.getDate() );
        day = ( day < 10 ) ? "0" + day : day;
        return date.getFullYear() + "-" + month + "-" + day;
    }

    function getTimeNow(dtmSeed)
    {
        var d = new Date(dtmSeed),
            h = (d.getHours()<10?'0':'') + d.getHours(),
            m = (d.getMinutes()<10?'0':'') + d.getMinutes(),
            s = (d.getSeconds()<10?'0':'') + d.getSeconds();
        return (h+':'+m+':'+s);
    }

    function generateRandomNumberRange(min_value , max_value) 
    {
        return Math.random() * (max_value-min_value) + min_value ;
    }

    function getRandomWord(slist,anythingRandom)
    {
        var arrL = slist.split(',');
        var i = generateRandomNumberRange(0,arrL.length-1).toFixed(0);
        return arrL[i];
    }

    function generateRandomString(len) {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

        for (var i = 0; i < len; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));

        return text;
    }

    function generateRandomNumber(len) {
        var text = "";
        var possible = "0123456789";

        for (var i = 0; i < len; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));

        return text;
    }

    function writeToLocalStorage(overwrite)
    {
        //localStorage.removeItem( Constants.lsFlag_dataMoved_redeemListIDB );

        if ( overwrite )
        {
            localStorage.setItem( 'redeemList', '{"list":[ ' +  $('textarea.output').val() + ' ] } ' );
        }
        else
        {
            var lsRed = JSON.parse( localStorage.getItem ('redeemList') ) ;

            if ( lsRed && lsRed.list )
            {
                var appList = JSON.parse( '[' + $('textarea.output').val() + ']' );
                var newList = lsRed.list.concat(appList);

                console.log( newList );
                console.log( JSON.stringify( newList ) );

                localStorage.setItem( 'redeemList', '{"list": ' + JSON.stringify( newList ) + ' } ' );
            }
            else
            {
                localStorage.setItem( 'redeemList', '{"list":[ ' +  $('textarea.output').val() + ' ] } ' );
            }

        }


        // After putting data to 'redeemList' on localStorage, set flag, so that data move happens to indexedDB
        // NOTE: We put this on localStorage, so that version move happens smoothly?
        localStorage.removeItem( Constants.lsFlag_dataMoved_redeemListIDB );

        //if ( $( '#deleteIndexedDB' ).is(':checked') ) deleteIndexedDB( 'cwsdb' );        
    }

    deleteIndexedDB = function(dbName)
    {
        var bProceed = confirm( "are you sure you want to delete indexedDB? It will erase EVERYTHING you've already captured");

        if ( bProceed )
        {
            var req = indexedDB.deleteDatabase(dbName);
            req.onsuccess = function () {
                alert ("Deleted indexed DB successfully");
            };
            req.onerror = function () {
                alert ("Couldn't delete database");
            };
            req.onblocked = function () {
                alert ("Couldn't delete database due to the operation being blocked");
            };

        }
       
    }

    var tmr;

    //me.
    whatEver = function()
    {

        setInterval( function() {

            $( 'img.rotImg' ).css( 'transform', 'rotateY(180deg)' );
            $( 'img.rotImg' ).attr( 'data-on', 0 );

            if ( tmr ) clearInterval( tmr );

            tmr = setTimeout( function() { // timeout (500) used to create image rotation effect (requires 1s transition on img obj)
                $( 'img.rotImg' ).css( 'transform', 'rotateY(360deg)' );
                $( '#imgNetworkStatus' ).attr( 'data-on', 1 );
            }, 500 );

        }, 1000 );

    }
    
    </script>


    <div id="f2_container">
        <div id="f2_card" class="shadow">
            <div class="rotTest">
                <img class="rotImg" src="images/Connect.svg" style=""/>
            </div>
        </div>
    </div>


    <style>
    #f1_container {
    position: relative;
    margin: 10px auto;
    width: 24px;
    height: 24px;
    z-index: 1;
    display: none;
    }
    #f2_container {
    position: relative;
    margin: 10px auto;
    width: 24px;
    height: 24px;
    z-index: 1;
    display: none;
    }
    #f1_container {
    perspective: 1000;
    }
    #f1_card {
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
    transition: all 1.0s linear;
    }
    #f1_container:hover #f1_card {
    transform: rotateY(360deg);
    }
    .face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    }
    .face.back {
    display: block;
    transform: rotateY(0deg);
    box-sizing: border-box;
    color: white;
    text-align: center;
    background-color: #fff;
    }
    </style>

  </body>

</html>